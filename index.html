<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz + Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      max-width: 700px;
      width: 90%;
    }
    h2, h3 {
      text-align: center;
      color: #333;
    }
    label {
      font-weight: bold;
      color: #555;
    }
    input, textarea, select {
      padding: 10px;
      width: 100%;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      padding: 12px;
      width: 100%;
      border: none;
      background: #66a6ff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 6px 0;
    }
    button:hover {
      background: #4f8dde;
    }
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 12px 0;
    }
    .rules {
      background: #e0f7ff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="container">
    <div id="home-screen">
      <h2>Bienvenue sur le Quiz üéâ</h2>
      <div class="rules">
        <h3>R√®gles :</h3>
        <ul>
          <li>Travaillez en √©quipe.</li>
          <li>1 r√©ponse par question.</li>
          <li>Bonne chance √† tous !</li>
        </ul>
      </div>
      <button id="joueur-btn">Joueur</button>
      <button id="admin-btn">Admin</button>
    </div>

    <div id="joueur-screen" style="display:none;">
      <h2>Bienvenue sur le Quiz üéÆ</h2>
      <label for="teamname">Nom d‚Äô√©quipe :</label>
      <input id="teamname" type="text" placeholder="Votre √©quipe">
      <button id="start-btn">Commencer le quiz</button>
    </div>

    <h2 id="question-title" style="display:none;"></h2>
    <div id="options" style="display:none;"></div>
    <div id="score-container" style="display:none;"></div>

    <div id="admin-screen" style="display:none;">
      <h2>R√©sultats du quiz</h2>
      <input id="admin-password" type="password" placeholder="Mot de passe admin">
      <button id="validate-admin-btn">Valider</button>
      <button id="refresh-btn" style="display:none;">Rafra√Æchir les scores</button>
      <button id="reset-btn" style="display:none;">R√©initialiser les r√©sultats</button>

      <div id="admin-results" style="margin-top:20px;"></div>

      <div id="edit-questions" style="display:none; margin-top: 20px;">
        <h3>Ajouter une question</h3>
        <textarea id="new-question" placeholder="Texte de la question"></textarea>
        <select id="question-type">
          <option value="choix">Choix multiple</option>
          <option value="libre">R√©ponse libre</option>
        </select>
        <div id="options-inputs">
          <input class="option-input" placeholder="Option 1">
          <input class="option-input" placeholder="Option 2">
          <input class="option-input" placeholder="Option 3">
          <input class="option-input" placeholder="Option 4">
          <input class="option-input" placeholder="Option 5">
          <input id="correct-answer" placeholder="Indice bonne r√©ponse (0 √† 4)">
        </div>
        <button id="add-question-btn">Ajouter la question</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const firebaseConfig = {
        apiKey: "AIzaSyDxfxlXSJNmV_LOTMfWDPfh5WEMGZiU0cw",
        authDomain: "quiz-cmi.firebaseapp.com",
        databaseURL: "https://quiz-cmi-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "quiz-cmi",
        storageBucket: "quiz-cmi.appspot.com",
        messagingSenderId: "442390350641",
        appId: "1:442390350641:web:373dabe481fb9242147e10"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let questions = [];
      let index = 0;
      let score = 0;
      let teamName = '';
      let reponsesUtilisateur = [];

      const title = document.getElementById('question-title');
      const optionsDiv = document.getElementById('options');
      const scoreContainer = document.getElementById('score-container');

      document.getElementById('joueur-btn').onclick = () => {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('joueur-screen').style.display = 'block';
      };
      document.getElementById('admin-btn').onclick = () => {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('admin-screen').style.display = 'block';
      };
      document.getElementById('start-btn').onclick = () => {
        teamName = document.getElementById('teamname').value.trim();
        if (!teamName) return alert('Veuillez entrer le nom de votre √©quipe.');
        document.getElementById('joueur-screen').style.display = 'none';
        title.style.display = 'block';
        optionsDiv.style.display = 'block';
        chargerQuestions(() => afficherQuestion());
      };

      document.getElementById('validate-admin-btn').onclick = () => {
        const pass = document.getElementById('admin-password').value;
        if (pass === "100719") {
          document.getElementById('reset-btn').style.display = 'block';
          document.getElementById('refresh-btn').style.display = 'block';
          document.getElementById('edit-questions').style.display = 'block';
          chargerScores();
        } else {
          alert('Mot de passe incorrect.');
        }
      };
      document.getElementById('refresh-btn').onclick = () => chargerScores();
      document.getElementById('reset-btn').onclick = () => {
        if (confirm('Es-tu s√ªr de vouloir supprimer tous les r√©sultats ?')) {
          db.ref('scores/').remove().then(() => {
            document.getElementById('admin-results').innerHTML = '<p>Tous les r√©sultats ont √©t√© supprim√©s.</p>';
          });
        }
      };

      document.getElementById('add-question-btn').onclick = () => {
        const qText = document.getElementById('new-question').value.trim();
        const qType = document.getElementById('question-type').value;
        if (!qText) return alert("Remplis la question.");

        if (qType === "choix") {
          const opts = Array.from(document.querySelectorAll('.option-input')).map(o => o.value.trim()).filter(o => o);
          const ans = parseInt(document.getElementById('correct-answer').value);
          if (opts.length < 2 || isNaN(ans) || ans < 0 || ans >= opts.length) return alert("Remplis correctement les options et la bonne r√©ponse.");
          db.ref('questions/').push({ question: qText, options: opts, answer: ans, type: "choix" });
        } else {
          db.ref('questions/').push({ question: qText, type: "libre" });
        }
        alert("Question ajout√©e !");
      };

      function chargerQuestions(callback) {
        db.ref('questions/').once('value').then((snapshot) => {
          questions = [];
          snapshot.forEach((child) => {
            questions.push(child.val());
          });
          callback();
        });
      }

      function afficherQuestion() {
        if (index >= questions.length) return afficherResultats();
        const q = questions[index];
        title.innerText = q.question;
        optionsDiv.innerHTML = '';
        if (q.type === "choix") {
          q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.innerText = opt;
            btn.onclick = () => verifierReponse(i);
            optionsDiv.appendChild(btn);
          });
        } else {
          const input = document.createElement('input');
          input.type = "text";
          input.placeholder = "Votre r√©ponse";
          optionsDiv.appendChild(input);
          const submit = document.createElement('button');
          submit.innerText = "Valider";
          submit.onclick = () => verifierReponse(input.value);
          optionsDiv.appendChild(submit);
        }
      }

      function verifierReponse(choix) {
        const q = questions[index];
        if (q.type === "choix") {
          const bonne = q.answer;
          if (choix === bonne) score++;
          reponsesUtilisateur.push({ question: q.question, bonne, choisi: choix, options: q.options });
        } else {
          reponsesUtilisateur.push({ question: q.question, reponseLibre: choix });
        }
        index++;
        afficherQuestion();
      }

      function envoyerResultat(teamName, score, reponsesUtilisateur) {
        db.ref('scores/').push({ teamName, score, answers: reponsesUtilisateur, timestamp: new Date().toISOString() })
          .then(() => console.log('‚úÖ sauvegard√© dans Firebase'))
          .catch((error) => console.error('‚ùå erreur:', error));
      }

      function afficherResultats() {
        title.style.display = 'none';
        optionsDiv.style.display = 'none';
        scoreContainer.style.display = 'block';
        envoyerResultat(teamName, score, reponsesUtilisateur);
        scoreContainer.innerHTML = `<h3>Merci d'avoir particip√©, ${teamName} ! üéâ</h3><p>Vos r√©ponses ont √©t√© enregistr√©es.</p>`;
      }

      function chargerScores() {
        const container = document.getElementById('admin-results');
        container.innerHTML = '';
        db.ref('scores/').once('value').then((snapshot) => {
          let allScores = [];
          snapshot.forEach((child) => allScores.push(child.val()));
          allScores.sort((a, b) => b.score - a.score);
          allScores.forEach((data, i) => {
            container.innerHTML += `
              <hr>
              <p><strong>${i + 1}. ${data.teamName}</strong> ‚Äî Score: ${data.score}</p>
              <details><summary>Voir les r√©ponses</summary>
                ${data.answers.map((ans, j) => {
                  if (ans.reponseLibre !== undefined) {
                    return `<p>${j + 1}. ${ans.question}<br>R√©ponse libre: ${ans.reponseLibre}</p>`;
                  } else {
                    return `<p>${j + 1}. ${ans.question}<br>Choisi: ${ans.options[ans.choisi]}<br>Bonne r√©ponse: ${ans.options[ans.bonne]}</p>`;
                  }
                }).join('')}
              </details>`;
          });
        });
      }

      setInterval(() => {
        if (document.getElementById('admin-screen').style.display !== 'none' &&
            document.getElementById('refresh-btn').style.display !== 'none') {
          chargerScores();
        }
      }, 10000);
    });
  </script>
</body>
</html>
